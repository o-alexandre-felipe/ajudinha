<html>
<head>
<script>

//https://stackoverflow.com/questions/1484506/random-color-generator
function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

function trContext(ctx, ns, ppm){
  this.blk = [];
  for(var i = 0; i < ns; ++i){
    this.blk[i] = getRandomColor();
  }
  this.ppm = ppm;
  this.ns = ns;
  this.fifoDepth = 6;
  this.ptr = 3;
  this.reptr = 0;
  this.shiftPtr = 0;
  this.mi = 0;
  this.cg = 0;
  this.cgv = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
  this.ctx = ctx;
}
trContext.prototype.shift = function(){
  this.mi = this.mi + this.ppm * this.ns;
  this.shiftPtr += Math.floor(this.mi);
  this.mi -= Math.floor(this.mi);
  this.cg = 0;
  if(this.shiftPtr > this.ns){
    this.shiftPtr -= this.ns;
    this.ptr += 1;
  }else if(this.shiftPtr < 0){
    this.shiftPtr += this.ns;
    if(this.ptr > 0){
      this.ptr -= 1;
    }else{
      this.cg = 1;
    }
  }
  for(i = 1; i < this.cgv.length; ++i){
    this.cgv[i] = this.cgv[i-1];
  }
  this.cgv[0] = this.cg;
}

trContext.prototype.drawFIFO = function(){
  this.ctx.save();
  this.ctx.translate(95, 45);
  this.ctx.scale(78, 218 /(this.fifoDepth));
  for(var i = 0; i < this.fifoDepth; ++i){
    if(i <= this.ptr){
      this.ctx.fillStyle = "#ffa000";
    }else{
      this.ctx.fillStyle = "#d0d0d0";
    }
    this.ctx.fillRect(0, (this.fifoDepth-i-0.9), 1, 0.8);
  }
  this.ctx.restore();
}

trContext.prototype.drawBarrelShifter = function(){
  this.ctx.save();
  this.ctx.translate(211, 45);
  this.ctx.scale(50, 218 /(2*this.ns));
  this.ctx.fillStyle = "#ffa000";
  for(var i = 0; i < this.ns; ++i){
    this.ctx.fillRect(0.0, (this.shiftPtr + i), 1, 0.8);
  }
  this.ctx.fillStyle = "#d0d0d0";
  for(var i = 0; i < this.shiftPtr; ++i){
    this.ctx.fillRect(0, i, 1, 0.8);
  }
  for(var i = this.shiftPtr; i < this.ns; ++i){
    this.ctx.fillRect(0, (this.ns + i), 1, 0.8);
  }
  this.ctx.restore();
}

trContext.prototype.drawCG = function(){
  var centerX = 275;
  var centerY = 50;
  var radius = 10;
  if(this.cg){
    this.ctx.fillStyle = "#ff0000";
  }else{
    this.ctx.fillStyle = "#00c000";
  }
  this.ctx.beginPath();
  this.ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
  this.ctx.fill();
  centerX = 470;
  centerY = 30;
  if(this.cgv[this.cgv.length-1]){
    this.ctx.fillStyle = "#ff0000";
  }else{
    this.ctx.fillStyle = "#00c000";
  }
  this.ctx.beginPath();
  this.ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
  this.ctx.fill();
}

trContext.prototype.drawInterp = function(c1, c2, w){
  this.ctx.save();
  this.ctx.translate(315, 30);
  this.ctx.scale((439-315), (270-90));
  function f(x){
    return 0.2 + 0.6 * (0.5*(1+Math.cos(Math.PI*x)));
  }
  this.ctx.lineWidth = w;
  this.ctx.beginPath();
  this.ctx.strokeStyle = c1;
  this.ctx.moveTo(0, f(0.25));
  for(var x = 0.02; x < 1; x += 0.02){
    this.ctx.lineTo(x, f(x+0.25));
  }
  this.ctx.stroke();

  this.ctx.beginPath();
  this.ctx.lineWidth = w;
  this.ctx.strokeStyle = c2;
  this.ctx.moveTo(0, f(this.mi*0.5));
  for(var x = 0.02; x < 1; x += 0.02){
    this.ctx.lineTo(x, f(x+this.mi*0.5));
  }
  this.ctx.stroke();
  this.ctx.restore();
}


function redraw(){
  var prev_ptr = window.tr.ptr;
  var prev_shiftPtr = window.tr.shiftPtr;
  this.tr.drawInterp("white", "white", 0.02);
  window.tr.shift();
  window.tr.drawCG();
  if(this.ptr != prev_ptr){
    window.tr.drawFIFO();
  }
  if(this.shiftPtr != prev_shiftPtr){
    window.tr.drawBarrelShifter();
  }
  this.tr.drawInterp("#0000ff", "#ff0000", 0.01);
  window.setTimeout(redraw, 100)
}
window.addEventListener('load', function () {
  var obj = document.getElementById("myCanvas");
  window.tr = new trContext(obj.getContext("2d"), 8, -0.01);
  window.tr.drawBlocks();
  window.tr.drawBarrelShifter();
  window.tr.drawFIFO();
  window.setTimeout(redraw, 50);
})

</script>
<script>
// Addapted from code generated by http://canvimation.github.io/
trContext.prototype.drawBlocks = function()
{
  var ctx = this.ctx;
  //forward;
  ctx.shadowColor ="rgba(0,0,0,0)";
  ctx.strokeStyle ="rgba(0,0,0,1)";
  ctx.lineWidth = 1;
  ctx.lineCap = "butt";
  ctx.lineJoin = "miter";
  ctx.beginPath();
  ctx.moveTo(49,16);
  ctx.lineTo(486,16);
  ctx.lineTo(486,293);
  ctx.lineTo(49,293);
  ctx.lineTo(49,16);
  ctx.closePath();
  ctx.stroke();
  ctx.shadowOffsetX = 15;
  ctx.shadowOffsetY = 15;
  ctx.shadowBlur = 0;
  ctx.shadowColor = "rgba(0,0,0,0)";
  ctx.fillStyle = "rgba(255,255,255,1)";
  ctx.fill();

  //Buffer;
  ctx.shadowColor ="rgba(0,0,0,0)";
  ctx.strokeStyle ="rgba(0,0,0,1)";
  ctx.lineWidth = 1;
  ctx.lineCap = "butt";
  ctx.lineJoin = "miter";
  ctx.beginPath();
  ctx.moveTo(72,30);
  ctx.lineTo(290,30);
  ctx.lineTo(290,271);
  ctx.lineTo(72,271);
  ctx.lineTo(72,30);
  ctx.closePath();
  ctx.stroke();
  ctx.shadowOffsetX = 15;
  ctx.shadowOffsetY = 15;
  ctx.shadowBlur = 0;
  ctx.shadowColor = "rgba(0,0,0,0)";
  ctx.fillStyle = "rgba(255,255,255,1)";
  ctx.fill();

  //interp;
  ctx.shadowColor ="rgba(0,0,0,0)";
  ctx.strokeStyle ="rgba(0,0,0,1)";
  ctx.lineWidth = 1;
  ctx.lineCap = "butt";
  ctx.lineJoin = "miter";
  ctx.beginPath();
  ctx.moveTo(315,30);
  ctx.lineTo(439,30);
  ctx.lineTo(439,270);
  ctx.lineTo(315,270);
  ctx.lineTo(315,30);
  ctx.closePath();
  ctx.stroke();
  ctx.shadowOffsetX = 15;
  ctx.shadowOffsetY = 15;
  ctx.shadowBlur = 0;
  ctx.shadowColor = "rgba(0,0,0,0)";
  ctx.fillStyle = "rgba(255,255,255,1)";
  ctx.fill();

  //NCO;
  ctx.shadowColor ="rgba(0,0,0,0)";
  ctx.strokeStyle ="rgba(0,0,0,1)";
  ctx.lineWidth = 1;
  ctx.lineCap = "butt";
  ctx.lineJoin = "miter";
  ctx.beginPath();
  ctx.moveTo(136,322);
  ctx.lineTo(361,322);
  ctx.lineTo(361,414);
  ctx.lineTo(136,414);
  ctx.lineTo(136,322);
  ctx.closePath();
  ctx.stroke();
  ctx.shadowOffsetX = 15;
  ctx.shadowOffsetY = 15;
  ctx.shadowBlur = 0;
  ctx.shadowColor = "rgba(0,0,0,0)";
  ctx.fillStyle = "rgba(255,255,255,1)";
  ctx.fill();

  //FIFO;
  ctx.shadowColor ="rgba(0,0,0,0)";
  ctx.strokeStyle ="rgba(0,0,0,1)";
  ctx.lineWidth = 1;
  ctx.lineCap = "butt";
  ctx.lineJoin = "miter";
  ctx.beginPath();
  ctx.moveTo(95,45);
  ctx.lineTo(173,45);
  ctx.lineTo(173,263);
  ctx.lineTo(95,263);
  ctx.lineTo(95,45);
  ctx.closePath();
  ctx.stroke();
  ctx.shadowOffsetX = 15;
  ctx.shadowOffsetY = 15;
  ctx.shadowBlur = 0;
  ctx.shadowColor = "rgba(0,0,0,0)";
  ctx.fillStyle = "rgba(255,255,255,1)";
  ctx.fill();

  //barrelShift;
  ctx.shadowColor ="rgba(0,0,0,0)";
  ctx.strokeStyle ="rgba(0,0,0,1)";
  ctx.lineWidth = 1;
  ctx.lineCap = "butt";
  ctx.lineJoin = "miter";
  ctx.beginPath();
  ctx.moveTo(211,45);
  ctx.lineTo(261,45);
  ctx.lineTo(261,263);
  ctx.lineTo(211,263);
  ctx.lineTo(211,45);
  ctx.closePath();
  ctx.stroke();
  ctx.shadowOffsetX = 15;
  ctx.shadowOffsetY = 15;
  ctx.shadowBlur = 0;
  ctx.shadowColor = "rgba(0,0,0,0)";
  ctx.fillStyle = "rgba(255,255,255,1)";
  ctx.fill();
}


</script>
</head>

<body>
<canvas id="myCanvas" width="500" height="320">
</canvas>
</body>
</html>

